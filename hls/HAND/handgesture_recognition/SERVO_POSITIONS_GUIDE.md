# 硬件舵机位置填入指南

## 系统架构更新

```
前端: 用户做手势
    ↓
模型识别: "one_sign" (由代码自动做)
    ↓
置信度检查: 92% > 70%? YES
    ↓
查找舵机位置: gesture_actions.json 中 one_sign.servo_positions
    ↓
硬件执行: 将 17 个舵机位置发送给 OrcaHand 驱动
    ↓
灵巧手: 执行对应的手势
```

## 关键概念分离

### 手势识别 (代码自动做) ✅
- 模型将用户动作识别为手势名称
- 输出: "one_sign", "V_sign", "OK_sign" 等

### 硬件舵机位置 (你需要填入) ⏳
- 识别出手势后，系统查找该手势对应的硬件舵机位置
- 这些位置直接发送给 OrcaHand 驱动控制灵巧手
- 位置值应该是硬件舵机接受的有效位置（具体范围取决于你的硬件规格）

## gesture_actions.json 文件结构

```json
{
  "one_sign": {
    "name": "一个手指竖起",
    "description": "食指竖起，其他手指弯曲",
    "servo_positions": [
      servo0,   // ← 关节0的舵机位置（你填）
      servo1,   // ← 关节1的舵机位置（你填）
      servo2,   // ← 关节2的舵机位置（你填）
      // ... 共17个
      servo16   // ← 关节16的舵机位置（你填）
    ]
  },
  "V_sign": { ... },
  "OK_sign": { ... }
}
```

## 填入舵机位置的步骤

### 步骤 1: 了解你的硬件规格

查找以下信息：
- 每个舵机的有效位置范围是多少？(例如: 0-4095, 0-270°, -180 to 180° 等)
- 舵机位置单位是什么？(脉冲宽度, 度数, 百分比 等)
- 中立位置(rest position)是多少？

**示例**:
```
关节0 (中指abd):
  - 范围: 0-4095 (PWM脉冲宽度)
  - 中立: 2048

关节1 (食指abd):
  - 范围: 0-4095
  - 中立: 2048

...以此类推
```

### 步骤 2: 编辑 gesture_actions.json

找到对应的手势，填入舵机位置。**示例**:

```json
{
  "one_sign": {
    "name": "一个手指竖起",
    "description": "食指竖起，其他手指弯曲",
    "servo_positions": [
      2500,    // 关节0: 中指abd
      2300,    // 关节1: 食指abd
      3000,    // 关节2: 食指pip (高位置 = 竖起)
      3200,    // 关节3: 食指mcp
      2000,    // 关节4: 拇指abd
      2100,    // 关节5: 拇指dip
      2100,    // 关节6: 拇指pip
      2200,    // 关节7: 拇指mcp
      2200,    // 关节8: 中指pip
      2200,    // 关节9: 中指mcp
      2400,    // 关节10: 小指abd
      2200,    // 关节11: 小指mcp
      2200,    // 关节12: 小指pip
      2300,    // 关节13: 无名指abd
      2200,    // 关节14: 无名指mcp
      2200,    // 关节15: 无名指pip
      2048     // 关节16: 手腕
    ]
  }
}
```

### 步骤 3: 测试

1. 启动服务器:
```bash
python hand_netserver.py
```

2. 观察启动日志，检查是否有警告:
```
✓ Loaded gesture actions: ['one_sign', 'V_sign', 'OK_sign', 'neutral']
```

3. 做出相应的手势，观察硬件反应

4. 如果硬件位置不对，调整 servo_positions 中的值

## 调试流程

### 症状: 系统输出 "servo_positions not filled" 的警告

**原因**: gesture_actions.json 中某个手势的 servo_positions 包含 null 值

**解决方案**:
```json
"servo_positions": [
  null,    // ❌ 还没填，系统会警告
  2300,    // ✅ 已填
  3000,    // ✅ 已填
  ...
]
```

填入所有 null 值即可。

### 症状: 硬件执行错误的动作

**原因**: 舵机位置值不正确

**调试步骤**:
1. 检查值的范围是否合理（是否超出硬件范围）
2. 逐个关节调整，观察硬件反应
3. 参考硬件手册找到正确的位置值

**示例调整**:
```json
// 如果食指没有正确竖起
"servo_positions": [
  2500,    // 中指abd
  2300,    // 食指abd
  3200,    // 食指pip 改为 3200（更高）试试
  3200,
  ...
]
```

## 常用模板

### 模板 1: 所有关节都放松 (中立位置)

```json
"neutral": {
  "name": "中立位置",
  "description": "所有手指放松",
  "servo_positions": [
    2048, 2048, 2048, 2048, 2048,
    2048, 2048, 2048, 2048, 2048,
    2048, 2048, 2048, 2048, 2048,
    2048, 2048
  ]
}
```

### 模板 2: 所有关节都伸直

```json
"open_hand": {
  "name": "完全张开",
  "description": "所有手指伸直",
  "servo_positions": [
    3500, 3500, 3500, 3500, 3500,
    3500, 3500, 3500, 3500, 3500,
    3500, 3500, 3500, 3500, 3500,
    3500, 3500
  ]
}
```

### 模板 3: 完全握拳

```json
"fist": {
  "name": "握拳",
  "description": "所有手指弯曲",
  "servo_positions": [
    1500, 1500, 1500, 1500, 1500,
    1500, 1500, 1500, 1500, 1500,
    1500, 1500, 1500, 1500, 1500,
    1500, 1500
  ]
}
```

## 工作流示例

### 场景: 填入 "one_sign" 的舵机位置

1. **查阅硬件规格**:
   - 舵机范围: 0-4095 (PWM)
   - 食指伸直位置: ~3800
   - 其他手指弯曲位置: ~1500

2. **编辑 gesture_actions.json**:
   ```json
   "one_sign": {
     "servo_positions": [
       2000,    // 中指abd - 中立
       2000,    // 食指abd - 中立
       3800,    // 食指pip - 高（伸直）
       3800,    // 食指mcp - 高（伸直）
       1500,    // 拇指abd - 低（弯曲）
       1500,    // 拇指dip - 低（弯曲）
       1500,    // 拇指pip - 低（弯曲）
       1500,    // 拇指mcp - 低（弯曲）
       1500,    // 中指pip - 低（弯曲）
       1500,    // 中指mcp - 低（弯曲）
       1500,    // 小指abd - 低（弯曲）
       1500,    // 小指mcp - 低（弯曲）
       1500,    // 小指pip - 低（弯曲）
       1500,    // 无名指abd - 低（弯曲）
       1500,    // 无名指mcp - 低（弯曲）
       1500,    // 无名指pip - 低（弯曲）
       2048     // 手腕 - 中立
     ]
   }
   ```

3. **启动服务器测试**:
   ```bash
   python hand_netserver.py
   ```

4. **做 one_sign 手势**，观察硬件是否正确执行

5. **调整不对的值**，重复测试

## 快速参考

| 关节 | 中文名 | 用途 |
|------|--------|------|
| 0 | 中指abd | 中指张开/合拢 |
| 1 | 食指abd | 食指张开/合拢 |
| 2 | 食指pip | 食指中间关节弯曲 |
| 3 | 食指mcp | 食指根部弯曲 |
| 4 | 拇指abd | 拇指张开/合拢 |
| 5 | 拇指dip | 拇指远端弯曲 |
| 6 | 拇指pip | 拇指中间弯曲 |
| 7 | 拇指mcp | 拇指根部弯曲 |
| 8 | 中指pip | 中指中间弯曲 |
| 9 | 中指mcp | 中指根部弯曲 |
| 10 | 小指abd | 小指张开/合拢 |
| 11 | 小指mcp | 小指根部弯曲 |
| 12 | 小指pip | 小指中间弯曲 |
| 13 | 无名指abd | 无名指张开/合拢 |
| 14 | 无名指mcp | 无名指根部弯曲 |
| 15 | 无名指pip | 无名指中间弯曲 |
| 16 | 手腕 | 手腕旋转 |

## 关键提示

✨ **记住**: 
- `servo_positions` 中的值是**硬件舵机的实际位置**，不是关节角度
- 你需要根据自己的硬件规格填入正确的值
- 代码不会改变这些值，只是读取并发送给硬件
- 修改 gesture_actions.json 后，重启服务器即可生效

💡 **建议**:
1. 先测试 neutral 位置，确认硬件能正常接收舵机命令
2. 再逐个手势调整舵机位置
3. 记下每个关节的有用位置值，方便以后调整

🔧 **故障排除**:
- 如果硬件不动，检查舵机位置值是否在有效范围内
- 如果某个关节动作奇怪，单独调整该关节的值
- 如果硬件报错，检查值是否超出范围或格式是否正确

---

**现在你可以填入自己的舵机位置了！** 🚀
